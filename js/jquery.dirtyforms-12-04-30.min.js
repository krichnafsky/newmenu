/*!
	Copyright 2010 Mal Curtis
*/
if(typeof jQuery=="undefined"){throw ("jQuery Required");}(function(c){c.extend({DirtyForms:{debug:false,message:"You've made changes on this page which aren't saved. If you leave you will lose these changes.",title:"Are you sure you want to do that?",dirtyClass:"dirty",listeningClass:"dirtylisten",ignoreClass:"ignoredirty",choiceContinue:false,helpers:[],dialog:{refire:function(v,u){return false;},fire:function(u,v){ehrsDirtyFormsModalDialogShow();},bind:function(){var u=function(v){return function(w){w.preventDefault();ehrsDirtyFormsModalDialogHide();v(w);};};c("#ehrsDirtyFormsModalDialog .modal-footer .cancel").click(u(k));c("#ehrsDirtyFormsModalDialog .modal-footer .continue").click(u(m));},stash:function(){return false;},selector:"#ehrsDirtyFormsModalDialog"},isDirty:function(){return c(":dirtylistening").dirtyForms("isDirty");},disable:function(){q.disabled=true;},choiceCommit:function(u){l(u);},isDeciding:function(){return q.deciding;},decidingContinue:function(u){m(u);},decidingCancel:function(u){k(u);},dirtylog:function(u){i(u);}}});c.extend(c.expr[":"],{dirtylistening:function(u){return c(u).hasClass(c.DirtyForms.listeningClass);},dirty:function(u){return c(u).hasClass(c.DirtyForms.dirtyClass);}});var r={init:function(){var u=c.DirtyForms;i("Adding forms to watch");n();return this.each(function(w){if(!c(this).is("form")){return;}i("Adding form "+c(this).attr("id")+" to forms to watch");c(this).addClass(u.listeningClass);var y="textarea,input:not([type='checkbox'],[type='radio'],[type='button'],[type='image'],[type='submit'],[type='reset'],[type='file'],[type='search'])";var x="input[type='checkbox'],input[type='radio'],select";var v="input[type='reset'],button[type='reset']";if(typeof c(document).on==="function"){c(this).on("focus blur",y,b);c(this).on("change",x,h);c(this).on("click",v,g);}else{c(this).delegate(y,"focus change",b);c(this).delegate(x,"change",h);c(this).delegate(v,"click",g);}});},isDirty:function(){var v=false;var u=this;if(q.disabled){return false;}if(p()){v=true;return true;}this.each(function(w){if(c(this).hasClass(c.DirtyForms.dirtyClass)){v=true;return true;}});c.each(c.DirtyForms.helpers,function(w,x){if("isDirty" in x){if(x.isDirty(u)){v=true;return true;}}if("isNodeDirty" in x){if(x.isNodeDirty(u)){v=true;return true;}}});i("isDirty returned "+v);return v;},setDirty:function(){i("setDirty called");return this.each(function(u){c(this).addClass(c.DirtyForms.dirtyClass).parents("form").addClass(c.DirtyForms.dirtyClass);});},setClean:function(){i("setClean called");q.focused={element:false,value:false};return this.each(function(w){var v=this;c(v).removeClass(c.DirtyForms.dirtyClass);if(c(v).is("form")){c(v).find(":dirty").removeClass(c.DirtyForms.dirtyClass);}else{var u=c(v).parents("form");if(u.find(":dirty").length==0){u.removeClass(c.DirtyForms.dirtyClass);}}c.each(c.DirtyForms.helpers,function(x,y){if("setClean" in y){y.setClean(v);}});});}};c.fn.dirtyForms=function(u){if(r[u]){return r[u].apply(this,Array.prototype.slice.call(arguments,1));}else{if(typeof u==="object"||!u){return r.init.apply(this,arguments);}else{c.error("Method "+u+" does not exist on jQuery.dirtyForms");}}};c.fn.setDirty=function(){return this.dirtyForms("setDirty");};c.fn.isDirty=function(){return this.dirtyForms("isDirty");};c.fn.cleanDirty=function(){return this.dirtyForms("setClean");};var q=c.DirtyForms=c.extend({disabled:false,exitBound:false,formStash:false,dialogStash:false,deciding:false,decidingEvent:false,currentForm:false,hasFirebug:"console" in window&&"firebug" in window.console,hasConsoleLog:"console" in window&&"log" in window.console,focused:{element:false,value:false}},c.DirtyForms);var g=function(){c(this).parents("form").dirtyForms("setClean");};var h=function(){c(this).dirtyForms("setDirty");};var b=function(){element=c(this);if(p()){q.focused.element.dirtyForms("setDirty");}q.focused.element=element;q.focused.value=element.val();};var p=function(){return q.focused.element&&(q.focused.element.val()!==q.focused.value);};var i=function(u){if(!c.DirtyForms.debug){return;}u="[DirtyForms] "+u;q.hasFirebug?console.log(u):q.hasConsoleLog?window.console.log(u):alert(u);};var n=function(){if(q.exitBound){return;}var u=(top!==self);if(typeof c(document).on==="function"){c(document).on("click","a",j);c(document).on("submit","form",f);if(u){c(top.document).on("click","a",j);c(top.document).on("submit","form",f);}}else{c(document).delegate("a","click",j);c(document).delegate("form","submit",f);if(u){c(top.document).delegate("a","click",j);c(top.document).delegate("form","submit",f);}}c(window).bind("beforeunload",a);if(u){c(top.window).bind("beforeunload",a);}q.exitBound=true;};var e=function(){var u="";c.each(c.DirtyForms.helpers,function(v,w){if("ignoreAnchorSelector" in w){if(u.length>0){u+=",";}u+=w.ignoreAnchorSelector;}});return u;};var j=function(u){if(!c(this).is(e())){s(u);}};var f=function(u){q.currentForm=this;s(u);};var a=function(v){var u=s(v);if(u&&q.doubleunloadfix!=true){i("Before unload will be called, resetting");q.deciding=false;}q.doubleunloadfix=true;setTimeout(function(){q.doubleunloadfix=false;},200);if(typeof(u)=="string"){v=v||window.event;if(v){v.returnValue=u;}return u;}};var s=function(u){i("Entering: Leaving Event fired, type: "+u.type+", element: "+u.target+", class: "+c(u.target).attr("class")+" and id: "+u.target.id);if(u.type=="beforeunload"&&q.doubleunloadfix){i("Skip this unload, Firefox bug triggers the unload event multiple times");q.doubleunloadfix=false;return false;}if(c(u.target).hasClass(q.ignoreClass)||o(u)){i("Leaving: Element has ignore class or has target='_blank'");if(!u.isDefaultPrevented()){t();}return false;}if(q.deciding){i("Leaving: Already in the deciding process");return false;}if(u.isDefaultPrevented()){i("Leaving: Event has been stopped elsewhere");return false;}if(!q.isDirty()){i("Leaving: Not dirty");if(!u.isDefaultPrevented()){t();}return false;}if(u.type=="submit"&&c(u.target).dirtyForms("isDirty")){i("Leaving: Form submitted is a dirty form");if(!u.isDefaultPrevented()){t();}return true;}q.deciding=true;q.decidingEvent=u;i("Setting deciding active");if(q.dialog!==false){i("Saving dialog content");q.dialogStash=q.dialog.stash();i(q.dialogStash);}c(document).trigger("defer.dirtyforms");if(u.type=="beforeunload"){i("Returning to beforeunload browser handler with: "+q.message);return q.message;}if(!q.dialog){return;}u.preventDefault();u.stopImmediatePropagation();if(c(u.target).is("form")&&c(u.target).parents(q.dialog.selector).length>0){i("Stashing form");q.formStash=c(u.target).clone(true).hide();}else{q.formStash=false;}i("Deferring to the dialog");q.dialog.fire(c.DirtyForms.message,c.DirtyForms.title);q.dialog.bind();};var o=function(v){var u=c(v.target).attr("target");if(typeof u==="string"){u=u.toLowerCase();}return(u==="_blank");};var l=function(u){if(q.deciding){c(document).trigger("choicecommit.dirtyforms");if(c.DirtyForms.choiceContinue){m(u);}else{k(u);}c(document).trigger("choicecommitAfter.dirtyforms");}};var k=function(u){u.preventDefault();c(document).trigger("decidingcancelled.dirtyforms");if(q.dialog!==false&&q.dialogStash!==false){i("Refiring the dialog with stashed content");q.dialog.refire(q.dialogStash.html(),u);}c(document).trigger("decidingcancelledAfter.dirtyforms");q.dialogStash=false;q.deciding=q.currentForm=q.decidingEvent=false;};var m=function(u){window.onbeforeunload=null;u.preventDefault();q.dialogStash=false;c(document).trigger("decidingcontinued.dirtyforms");d(q.decidingEvent);q.deciding=q.currentForm=q.decidingEvent=false;};var t=function(){i("Clearing the beforeunload event");c(window).unbind("beforeunload",a);window.onbeforeunload=null;};var d=function(x){c(document).trigger("beforeRefire.dirtyforms");switch(x.type){case"click":i("Refiring click event");var v=new jQuery.Event("click");c(x.target).trigger(v);if(!v.isDefaultPrevented()){var u=c(x.target).closest("[href]");i("Sending location to "+u.attr("href"));location.href=u.attr("href");return;}break;default:i("Refiring "+x.type+" event on "+x.target);var w;if(q.formStash){i("Appending stashed form to body");w=q.formStash;c("body").append(w);}else{w=c(x.target);if(!w.is("form")){w=w.closest("form");}}w.trigger(x.type);break;}};})(jQuery);